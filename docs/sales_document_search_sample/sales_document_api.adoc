= *Sales document search API implementation using enosix mule connector*

== *Pre-requites to follow along this tutorial*

* Anypoint Studio installed and in working condition.
* enosix SAP connector for Mule 4 trail account or valid license
* Download the SalesDocument RAML specification from here https://github.com/enosix/enosix-sales-document-api/blob/main/Sales_Document_Search-1.0.1-raml.zip[RAML]

== *Steps to create mule sales document search API*

1. Open Anypoint studio and create new Mule project as below screenshot
+
image::/docs/sales_document_search_sample/image/01_new_project.png[New project]

2. Make sure *Scaffold flows from these API specifications* check mark selected. You can use the RAML from local file system or import a published API option(from exchange), depends on you have RAML locally or directly refer from exchange as maven dependency.

3. if you selected local file system choose the RAML *Sales_Document_Search-1.0.1-raml.zip* location and click the finish button. Skip step 4 & 5 go to 6

4. Make sure you have downloaded RAML zip file uploaded to your exchange.Choose import a published API click green + (*Add new dependency*) button, you will be prompted exchange credentials and enter credentials. Search for enosix, you will find *Sales Document Search* RAML file, here is the screenshot.
+
image::/docs/sales_document_search_sample/image/02_select_raml.png[Select RAML]

5. Select the *Sales Document Search* RAML file and click **Add>** and *finish* button.
+
image::/docs/sales_document_search_sample/image/03_finish_project_creation.png[Finish project creation]
6. Now the base project with scaffold flow created with main apikit router, apikit console and end point implementation skeleton private flow.
+
image::/docs/sales_document_search_sample/image/04_scaffold_flow.png[Scaffold flow]
7. Now add enosix SAP connector for Mule 4 dependency to project. Click the search in exchange in *Mule Palette*, if you are not already login, login to exchange and search for enosix. You will find *enosix SAP Connector - Mule 4*
+
image::/docs/sales_document_search_sample/image/05_connector_search.png[Connector search]
8. Click *Add>* and *finish* button, enosix connector dependency add to your project. Make sure you have  ths dependency in pom.xml.
+
.pom.xml
[source,XML]
----
<!--Dependency for enosix SAP Connector -Mule 4 -->
<dependency>
    <groupId>com.enosix.mule</groupId>
	<artifactId>enosix-connector</artifactId>
	<version>1.0.0</version>
	<classifier>mule-plugin</classifier>
</dependency>
----
+
9. Drag and drop search operation from enosix connector in to enpoint implementation private flow
+
image::/docs/sales_document_search_sample/image/06_search_operation.png[Search operation]
10. Configure search operation, create a global configuration for connector by selecting green **+** in search operation configuration.
+
image::/docs/sales_document_search_sample/image/07_search_config.png[Search config]

a. URL : enter the enosix SAP framework endpoint.
b. username: enter the user name for enosix SAP framework.
c. password: enter the password for enosix SAP framework.
d. XSD Path: create a new folder *xsd* under src/main/resource and give the path here
e. Client: enter the SAP instance client number
f. Go to TLS tab, select *Edit inline* and select insecure option.
g. Click *Test connection* operation, once connection tested successful, click *OK* button
h. global configuration completed
+
Security reason original url, username and password taken out from screenshot, to get Idea here is the screenshot with dummy values.
+
image::/docs/sales_document_search_sample/image/08_global_config.png[Gloabl config]

11. You have Enosix_Config global configuration in Connector configuration, fill out the reaming config parameters for search operation
+
image::/docs/sales_document_search_sample/image/09_enosix_config.png[Enosix config]
12. Select Type *SFCISalesDocument* from drop down list
13. Click the *fx* icon for Page size,Page number and Search Input as we are entering the expression for these three parameters.

14. Enter Page size as *attributes.queryParams.pageSize*
15. Enter Page Number as *attributes.queryParams.pageNumber*
16. Enter search input below dataweave code. This dataweave code is creating XML input format required for connector
+
.Search Input
[source,dataweave]
----
%dw 2.0
output application/xml skipNullOn="everywhere"
fun convert(strBoolean)  = if(strBoolean)  'X'  else ''
---
SFCISalesDocument_SC: {
	SEARCHPARAMS @(CompletedOnly: convert(attributes.queryParams.completedOnly as Boolean default false),
    CustomerPONumber: attributes.queryParams.customerPONumber,
    FromCreateDate: attributes.queryParams.fromCreateDate,
    FromSalesDocumentNumber: attributes.queryParams.fromSalesDocumentNumber,
    Leading: attributes.queryParams.leading,
    Material: attributes.queryParams.material,
    OpenOnly: convert(attributes.queryParams.openOnly as Boolean default false),
    SalesDocumentVersionNumber: attributes.queryParams.salesDocumentVersionNumber,
    ShipToParty: attributes.queryParams.shipToParty,
    ShipToPurchaseOrderNumber: attributes.queryParams.shipToPurchaseOrderNumber,
    SoldToParty: attributes.queryParams.soldToParty,
    ToCreateDate: attributes.queryParams.toCreateDate,
    ToSalesDocumentNumber: attributes.queryParams.toSalesDocumentNumber,
    TransactionGroup: attributes.queryParams.transactionGroup,
    Username: attributes.queryParams.username,
    X_BillingBlock: convert(attributes.queryParams.billingBlock as Boolean default false),
    X_CreditBlock: convert(attributes.queryParams.creditBlock as Boolean default false),
    X_DeliveryBlock: convert(attributes.queryParams.deliveryBlock as Boolean default false),
    YourReference: attributes.queryParams.yourReference,
    tablerowstate: 'inserted' ) : null
}
----
+
17. Search operation configuration completed, your configuration should look like below screenshot.
+
image::/docs/sales_document_search_sample/image/10_search_conf_complete.png[Search config complete]

18. Work on the transformation step to convert search operation xml to json. Click on the Transform message dataweave component, remove the sample json document out there. Copy and paste below dataweave code into transformation
+
.Transform connector output xml to json using dataweave
[source,dataweave]
----
%dw 2.0
output application/xml skipNullOn="everywhere"
fun convert(strBoolean)  = if(strBoolean)  'X'  else ''
---
%dw 2.0
output application/json skipNullOn="everywhere"
---
 {
     "PageInfo": {
		"PageSize": attributes.pagingInfo.pageSize,
		"PageNumber":attributes.pagingInfo.pageNumber,
		 "TotalRecords":attributes.pagingInfo.totalRecords
	},
  "SalesDocuments": [
  	payload.SFCISalesDocument_SR.*SEARCHRESULT map {
      "SalesDocument": $.@SalesDocument,
      "CustomerPONumber": $.@CustomerPONumber,
      "CreateDate": $.@CreateDate,
      "SalesDocumentType": $.@SalesDocumentType,
      "SalesDocumentTypeDescription": $.@SalesDocumentTypeDescription,
      "SoldToParty": $.@SoldToParty,
      "SoldToName": $.@SoldToName,
      "SoldToCity": $.@SoldToCity,
      "SoldToRegion": $.@SoldToRegion,
      "SoldToRegionDescription": $.@SoldToRegionDescription,
      "SoldToCountry": $.@SoldToCountry,
      "SoldToCountryDescription": $.@SoldToCountryDescription,
      "ShipToParty": $.@ShipToParty,
      "ShipToName": $.@ShipToName,
      "ShipToCity": $.@ShipToCity,
      "ShipToRegion": $.@ShipToRegion,
      "ShipToRegionDescription": $.@ShipToRegionDescription,
      "ShipToCountry": $.@ShipToCountry,
      "ShipToCountryDescription": $.@ShipToCountryDescription,
      "NetValueInDocumentCurrency": $.@NetValueInDocumentCurrency,
      "TaxAmountInDocumentCurrency": $.@TaxAmountInDocumentCurrency,
      "SDDocumentCurrency": $.@SDDocumentCurrency,
      "OrderStatus": $.@OrderStatus,
      "SalesDocumentVersionNumber": $.@SalesDocumentVersionNumber,
      "YourReference": $.@YourReference,
      "ShipToPurchaseOrderNumber": $.@ShipToPurchaseOrderNumber,
      "TransactionGroup": $.@TransactionGroup,
      "DeliveryBlock": $.@DeliveryBlock,
      "DeliveryBlockDescription": $.@DeliveryBlockDescription,
      "BillingBlock": $.@BillingBlock,
      "BillingBlockDescription": $.@BillingBlockDescription,
      "CreditBlock": $.@CreditBlock,
      "CreditBlockDescription": $.@CreditBlockDescription,
      "DeliveryStatus": $.@DeliveryStatus,
      "DeliveryStatusDescription": $.@DeliveryStatusDescription,
      "TotalQuantity": $.@TotalQuantity,
      "GoodsIssuedQuantity": $.@GoodsIssuedQuantity,
      "LastChangedDate": $.@LastChangedDate,
      "StartDate": $.@StartDate,
      "EndDate": $.@EndDate,
      "CUSTOM01": $.@CUSTOM01,
      "CUSTOM02": $.@CUSTOM02,
      "CUSTOM03": $.@CUSTOM03,
      "CUSTOM04": $.@CUSTOM04,
      "CUSTOM05": $.@CUSTOM05,
      "CUSTOM06": $.@CUSTOM06,
      "CUSTOM07": $.@CUSTOM07,
      "CUSTOM08": $.@CUSTOM08,
      "CUSTOM09": $.@CUSTOM09,
      "CUSTOM10": $.@CUSTOM10
    }
  ]
}
----
+
19. Now the code completed for API implementation.You can run the project by right click anywhere on the flow. Make sure flow started without any errors by checking the console logs.
20. Send a request from postman / browser in this format  http://localhost:8081/api/search/salesdocument?soldToParty=2200&pageSize=100&pageNumber=1

Complete source code for this API is available in this link you can download and run in Anypoint studio.
https://github.com/enosix/enosix-sales-document-api[enosix-sales-document-api]